name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering 

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
      - name: Verify Tesseract folder exists
        run: |
          if (-not (Test-Path "tesseract\tesseract.exe")) {
            Write-Host "ERROR: Tesseract folder not found in tesseract/"
            Write-Host "Please ensure tesseract/ contains the portable Tesseract installation"
            Write-Host "The tesseract folder should be committed to the repository"
            exit 1
          }
          Write-Host "Tesseract found: tesseract\tesseract.exe"
          Write-Host "Tesseract will be bundled with the executable"
          
      - name: Build executable
        run: |
          pyinstaller build_exe.spec --clean
          
      - name: Verify executable
        run: |
          if (-not (Test-Path "dist\MapleAutocuber.exe")) {
            Write-Host "ERROR: Executable not found!"
            exit 1
          }
          Write-Host "Executable created successfully: dist\MapleAutocuber.exe"
          
      - name: Get version from tag
        id: get_version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          $version = "${{ github.ref }}".Replace("refs/tags/v", "")
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"
          
      - name: Get version from commit
        id: get_version_commit
        if: github.event_name == 'workflow_dispatch'
        run: |
          $version = "dev-${{ github.sha }}"
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"
          
      - name: Create release archive
        run: |
          $version = "${{ steps.get_version.outputs.version }}${{ steps.get_version_commit.outputs.version }}"
          if (-not $version) { $version = "latest" }
          
          # Create a release folder
          New-Item -ItemType Directory -Force -Path "release" | Out-Null
          
          # Copy executable
          Copy-Item "dist\MapleAutocuber.exe" -Destination "release\MapleAutocuber.exe"
          
          # Copy tesseract folder (should already be bundled, but include separately for reference)
          if (Test-Path "dist\tesseract") {
            Copy-Item "dist\tesseract" -Destination "release\tesseract" -Recurse
          }
          
          # Create README for release
          $readmeLines = @(
            "# Maple Autocuber Release",
            "",
            "Version: $version",
            "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
            "",
            "## Installation",
            "",
            "1. Extract all files to a folder",
            "2. Run MapleAutocuber.exe",
            "3. No additional installation required - Tesseract OCR is bundled!",
            "",
            "## Notes",
            "",
            "- The executable includes all dependencies",
            "- Tesseract OCR is bundled and will be used automatically",
            "- Run as Administrator if you encounter permission issues",
            "",
            "## Files",
            "",
            "- MapleAutocuber.exe - Main executable",
            "- tesseract/ - Bundled Tesseract OCR (already included in .exe, this is for reference)"
          )
          $readmeLines -join "`r`n" | Out-File -FilePath "release\README.txt" -Encoding UTF8
          
          # Create zip archive
          Compress-Archive -Path "release\*" -DestinationPath "MapleAutocuber-$version.zip" -Force
          Write-Host "Created archive: MapleAutocuber-$version.zip"
          
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MapleAutocuber-${{ steps.get_version.outputs.version }}${{ steps.get_version_commit.outputs.version }}
          path: |
            MapleAutocuber-*.zip
            release/
          retention-days: 30
        
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            MapleAutocuber-*.zip
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## Maple Autocuber ${{ steps.get_version.outputs.version }}
            
            ### Installation
            
            Download `MapleAutocuber-*.zip`, extract the archive, and run `MapleAutocuber.exe`.
            
            ### Features
            
            - ✅ Standalone executable - no Python installation required
            - ✅ Tesseract OCR bundled - no additional installation needed
            - ✅ All dependencies included
            
            ### Notes
            
            - Run as Administrator if you encounter permission issues
            - The executable is large (~100MB+) because it includes Python and all dependencies
            
            ### Changes
            
            See commit history for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

